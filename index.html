<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cardiac Display Screen</title>
<style>
  body {
    margin:0;
    background:#f5f7fb;
    font-family:-apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:#0f172a;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
  }
  h1 {
    font-size:clamp(48px,5vw,72px);
    font-weight:900;
    margin:0 0 20px;
  }
  .counter {
    display:flex;
    gap:60px;
    justify-content:center;
    flex-wrap:wrap;
    max-width:90vw;
  }
  .windowBox {
    background:#000;
    color:#fff;
    border-radius:20px;
    padding:40px 80px;
    text-align:center;
    min-width:300px;
    box-shadow:0 6px 16px rgba(0,0,0,0.25);
  }
  .windowBox h2 {
    margin:0;
    font-size:clamp(40px,4vw,60px);
  }
  .windowBox .ticket {
    margin-top:20px;
    font-size:clamp(72px,8vw,120px);
    font-weight:900;
    color:#38bdf8;
  }

  #soundGate {
    position:fixed; inset:0;
    background:#000a; color:#fff;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    z-index:9999; font:600 24px system-ui;
  }
  #soundGate button {
    margin-top:16px;
    padding:12px 24px;
    font-size:20px;
    border:0; border-radius:12px;
    background:#2563eb; color:#fff;
    font-weight:800; cursor:pointer;
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<!-- ✅ تفعيل الصوت -->
<div id="soundGate">
  <div>اضغط لتفعيل الصوت</div>
  <button onclick="document.getElementById('soundGate').style.display='none'; try{speechSynthesis.cancel()}catch(e){}">تفعيل الصوت</button>
</div>

<h1>شاشة نداء قسم القلب</h1>
<div class="counter" id="counterGrid"></div>

<script>
/* ========== Firebase ========== */
const cfg = {
  apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
  authDomain:"q-matic-b7d77.firebaseapp.com",
  databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
  projectId:"q-matic-b7d77",
  storageBucket:"q-matic-b7d77.appspot.com",
  messagingSenderId:"908187704899",
  appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
};
firebase.initializeApp(cfg);
const db = firebase.database();
const ROOT = "cardiac_demo";

/* ========== إنشاء مربعات الشباك ========== */
const grid = document.getElementById("counterGrid");
const windows = [1,2,3,4,5,6];
for (const w of windows){
  const box = document.createElement("div");
  box.className="windowBox";
  box.id=`win${w}`;
  box.innerHTML=`<h2>الشُبّاك ${w}</h2><div class="ticket" id="ticket${w}">--</div>`;
  grid.appendChild(box);
}

/* ========== أدوات نطق ========== */
function toArDigits(n){ return String(n).replace(/\d/g,d=>"٠١٢٣٤٥٦٧٨٩"[d]); }

function speakOnce(text) {
  return new Promise(resolve=>{
    if (!('speechSynthesis' in window)) {resolve();return;}
    text=text.replace(/[ٌٍْـ]/g,"").replace(/\s+/g," ").trim();
    const u=new SpeechSynthesisUtterance(text);
    u.lang='ar-SA'; u.rate=1.1; u.pitch=1.0;
    const v=(speechSynthesis.getVoices().find(v=>/naayf|naif|hoda|maged|arabic/i.test(v.name))||
             speechSynthesis.getVoices().find(v=>/ar(-|_)?[A-Z]{2}/i.test(v.lang))||
             speechSynthesis.getVoices()[0]);
    if(v)u.voice=v;
    u.onend=resolve; u.onerror=resolve;
    speechSynthesis.speak(u);
  });
}

function fixNumberWord(n){
  const map={1:"واحِد",2:"اِثنان",3:"ثَلاثَة",4:"أَربَعَة",5:"خَمسَة",6:"سِتَّة",7:"سَبعَة",8:"ثَمانِيَة",9:"تِسعَة",10:"عَشَرَة"};
  return map[n]?map[n]:toArDigits(n);
}

function buildFastPhrase(n,w){
  const z="\u200C"; const num=toArDigits(n);
  const wnum=(w==null||w==="")?"":fixNumberWord(w);
  if(!wnum)return`تَذْكِرَةْ رقم${z} ${num}`;
  return`تَذْكِرَةْ رقم${z} ${num} الرجاء${z} التوجه${z} إلى${z} الشُبّاك رقم${z} ${wnum}`;
}

/* ========== عرض التذكرة ========== */
function updateWindowCard(w,n,ts){
  const el=document.getElementById(`ticket${w}`);
  if(el){ el.textContent=n; el.dataset.ts=ts; }
}

/* ========== مستمع Firebase ========== */
db.ref(`${ROOT}/calls`)
  .orderByChild('ts')
  .on('child_added',snap=>{
    const v=snap.val()||{};
    const n=Number(v.number);
    const w=Number(v.window);
    if(!n||!w)return;

    updateWindowCard(w,n,v.ts||Date.now());

    // 🔊 نطق فوري
    const phrase=buildFastPhrase(n,w);
    speakOnce(phrase);
  });
</script>
</body>
</html>
