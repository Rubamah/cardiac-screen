<!DOCTYPE html>



<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Kiosk</title>

<style>
  :root{--blue:#2563eb;--ink:#0f172a;--muted:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:#f5f7fb;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
  body{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
  .wrap{margin:auto;width:min(960px,96vw);background:#eef2f7;padding:28px;border-radius:18px}
  .sub{font-size:18px;text-align:center;color:#334155;margin-bottom:6px}
  h1{font-size:clamp(40px,8.5vw,90px);margin:10px 0;text-align:center}
  form{display:flex;flex-direction:column;gap:14px;align-items:center}
  label{font-weight:700}
  input{width:100%;max-width:680px;padding:16px 18px;font-size:22px;border-radius:14px;border:2px solid #cbd5e1;letter-spacing:1px;text-align:center}
  input::placeholder{color:#9aa3b2;opacity:.9;text-align:center}
  input:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
  .btn{background:var(--blue);color:#fff;font-weight:800;border:0;padding:14px 22px;border-radius:14px;font-size:22px;cursor:pointer}
  .next{margin-top:8px;text-align:center;color:var(--muted)}
  .next b{color:#111}
  .err{min-height:22px;color:#dc2626;text-align:center}

  /* ===== قالب الطباعة ===== */
  @media print{
    @page{ size:80mm auto; margin:0 }
    body > *{ display:none !important }
    #ticket{ display:block !important;width:100%;padding:10mm 6mm;font-family:"Tahoma","Segoe UI","Arial",sans-serif;direction:rtl;text-align:center }
    #tTitle{ font-family:Arial,Helvetica,sans-serif;font-size:16pt;margin:0 0 6mm }
    #tHello{ display:block;width:100%;font-size:30pt;line-height:1.1;margin:0 0 4mm }
    #tSub{   display:block;width:100%;font-size:14pt;line-height:1.2;margin:0 0 6mm }
    #tNum{   display:block;width:100%;font-size:56pt;line-height:1.0;margin:0 0 6mm }
    #tMrn{   display:block;width:100%;font-size:14pt;margin:0 0 3mm }
    #tWait{  display:block;width:100%;font-size:13pt;margin:0 0 5mm }
    #tLine{  height:2px;background:#000;margin:3mm 0 }
    #tThanks{display:block;width:100%;font-size:20pt;margin:2mm 0 3mm }
    #tTs{    display:block;width:100%;font-size:11pt;margin:0 }
  }
  /* شاشة النداء داخل الكيوسك (لا تُطبع) */
#callDisplay {
  display: none;
  background: #000;
  color: #fff;
  text-align: center;
  padding: 40px 10px;
  border-radius: 16px;
  font-weight: 700;
  width: 100%;
  max-width: 680px;
  margin: 40px auto 40px; /* مسافة متوازنة فوق وتحت */
  line-height: 1.5;
  font-size: clamp(28px, 5vw, 44px);
  box-sizing: border-box;
}
#callDisplay b {
  font-weight: 800;
}
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
<div class="wrap">
  <div class="sub">Cardiac Pharmacy Ticket</div>
  <h1>مرحبًا</h1>

  <form id="f" autocomplete="off">
    <label for="mrn" class="sub" style="margin-top:8px">الرجاء إدخال رقم الملف (MRN)</label>
    <input id="mrn" inputmode="numeric" placeholder="MRN" />
    <button class="btn" type="submit">طباعة التذكرة / Print Ticket</button>
    <div class="next">الرقم التالي: <b><span id="nextNum">-</span></b></div>
    <div class="err" id="err"></div>
    <div class="sub">الرجاء الانتظار قليلًا لحين طباعة التذكرة</div>
  </form>

  <!-- هنا المستطيل -->
  <div id="callDisplay">
    تذكرة رقم (<b id="dispNum"></b>)<br>
    الرجاء التوجه للشباك
  </div>
</div>

  <!-- قالب التذكرة (يظهر فقط أثناء الطباعة) -->
  <div id="ticket" style="display:none">
    <div id="tTitle">Cardiac Pharmacy Ticket</div>
    <div id="tHello">مرحبًا</div>
    <div id="tSub">رقمك هو</div>
    <div id="tNum"></div>
    <div id="tMrn"></div>
    <div id="tWait"></div>
    <div id="tLine"></div>
    <div id="tThanks">شكرًا لانتظارك</div>
    <div id="tTs"></div>
  </div>
<body>
<script>
(function(){
  const PASS = "kpcreg";
  if(!sessionStorage.getItem("authOK")){
    const p = prompt("Please enter password:");
    if(p !== PASS){
      alert("Incorrect password. Access denied.");
      document.body.innerHTML = "<h2 style='text-align:center;margin-top:40vh'>Access Denied</h2>";
      throw new Error("Blocked"); // يوقف بقية الكود
    }
    sessionStorage.setItem("authOK","true");
  }
})();
</script>
<script>
(function(){
  // ===== Firebase =====
  const cfg={apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",authDomain:"q-matic-b7d77.firebaseapp.com",databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",projectId:"q-matic-b7d77",storageBucket:"q-matic-b7d77.appspot.com",messagingSenderId:"908187704899",appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"};
  firebase.initializeApp(cfg);
  const db=firebase.database();
  const ROOT="cardiac_demo";

  // عناصر
  const f=document.getElementById('f');
  const mrnInput=document.getElementById('mrn');
  const err=document.getElementById('err');
  const nextNumEl=document.getElementById('nextNum');

  // تحويل الأرقام العربية إلى إنجليزية + تنظيف
  const ar2en = s => String(s).replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d)).replace(/[^\d]/g,'');
  // تحويل إنجليزي إلى عربي لو احتجنا
  const toAr = n => String(n).replace(/\d/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);

  // نص “أمامك …” بصياغة صحيحة
  function waitingText(n){
    if(n===0) return 'لا يوجد أشخاص في الانتظار';
    if(n===1) return 'أمامك شخص واحد في الانتظار';
    if(n===2) return 'أمامك شخصان في الانتظار';
    return `أمامك ${toAr(n)} أشخاص في الانتظار`;
  }

  // يحسب next & waiting (printed && !served && !noshow)
  async function pickNextAndWaiting(){
    const [sp, ss, sn] = await Promise.all([
      db.ref(`${ROOT}/printed`).get(),
      db.ref(`${ROOT}/served`).get(),
      db.ref(`${ROOT}/noshow`).get()
    ]);
    const P=sp.val()||{}, S=ss.val()||{}, N=sn.val()||{};

    // next هو أول رقم غير موجود في أي من الجداول
    let next=1;
    while(next<=1000 && (P[next]||S[next]||N[next])) next++;

    // المنتظرين: مطبوع قبل next وغير مخدّم وغير NoShow
    let waiting=0;
    for(let i=1;i<next;i++){
      if(P[i] && !S[i] && !N[i]) waiting++;
    }
    return {next,waiting};
  }

  // معاينة الرقم التالي
  async function updateNextPreview(){
    const {next}=await pickNextAndWaiting();
    nextNumEl.textContent = toAr(next);
  }
  updateNextPreview();

  // مستمع Restart من الأوبريتور
  db.ref(`${ROOT}/resetFlag`).on('value', s=>{
    if(!s.exists()) return;
    mrnInput.value='';
    err.textContent='';
    updateNextPreview();
  });

  // إرسال/طباعة
  f.addEventListener('submit', async (e)=>{
    e.preventDefault();
    err.textContent='';

    const mrn = ar2en(mrnInput.value.trim());
    if (!mrn || mrn.trim() === "") return err.textContent = "الرجاء إدخال رقم الملف";
    if (mrn.length < 3) {
  err.textContent = "الرجاء إدخال رقم ملف صحيح";
  return; // يوقف العملية بالكامل وما يطبع
}

    // احسبي next الحقيقي لحظة الطباعة + المنتظرين قبل هذا الرقم
    const {next,waiting} = await pickNextAndWaiting();
    const ticketNum = next;

    // سجّلي مطبوع + MRN + latestPrinted
    await Promise.all([
      db.ref(`${ROOT}/printed/${ticketNum}`).set(true),
      db.ref(`${ROOT}/mrn/${ticketNum}`).set(mrn),
      db.ref(`${ROOT}/latestPrinted`).set({number:ticketNum,mrn})
    ]);

// 4) جهزي التذكرة
// نحول الأرقام إلى إنجليزية فقط
const enNum = n => String(n).replace(/[٠-٩]/g, d => dMap[d]);

document.getElementById('tNum').textContent = enNum(ticketNum);
document.getElementById('tMrn').textContent = `رقم الملف: ${enNum(mrn)}`;
document.getElementById('tWait').textContent = waiting === 0
  ? 'لا يوجد أحد أمامك'
  : waiting === 1 ? 'أمامك شخص واحد في الانتظار'
  : waiting === 2 ? 'أمامك شخصان في الانتظار'
  : `أمامك ${enNum(waiting)} أشخاص في الانتظار`;

const now = new Date();
const hh = now.getHours()%12 || 12, mm = String(now.getMinutes()).padStart(2,'0');
const ampm = now.getHours()>=12 ? 'PM':'AM';
const date = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()}`;
document.getElementById('tTs').textContent = `${hh}:${mm}${ampm} , ${date}`;

// 5) اطبعي
window.print();

    // نفرّغ الحقل ونحدّث المعاينة
    mrnInput.value='';
    updateNextPreview();
  });
})();
</script>
  <script>
(function(){
  const ROOT="cardiac_demo"; // نفس الجذر
  const disp=document.getElementById('callDisplay');
  const dispNum=document.getElementById('dispNum');
  const db=firebase.database();

db.ref(`${ROOT}/latest`).on('value', async s=>{
  const v=s && s.val();
  if(!v || !v.number){ disp.style.display='none'; return; }
  const n=v.number;
  const ns=await db.ref(`${ROOT}/noshow/${n}`).get();
  if(ns.exists()){ disp.style.display='none'; return; }

  dispNum.textContent = n;

  // جلب رقم الشباك من latest أو من operatorWindow
  const winNum = v.window || v.windowNum || null;
  const winText = winNum ? `الرجاء التوجه للشباك رقم (${winNum})` : `الرجاء التوجه للشباك`;

  disp.innerHTML = `تذكرة رقم (<b id="dispNum">${n}</b>)<br>${winText}`;
  disp.style.display = 'block';
});

})();
</script>
</body>
</html>
