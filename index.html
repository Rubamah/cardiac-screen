<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>لوحة النداء (Big Screen)</title>
<style>
  :root{
    --bg:#0b1220; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af;
    --accent:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Segoe UI",Tahoma,Arial,sans-serif}
  header{padding:14px 18px;text-align:center;font-weight:900;letter-spacing:.5px}
  header h1{margin:0;font-size:clamp(20px,3.5vw,32px)}
  .hint{ text-align:center; color:#9ca3af; margin:6px 0 2px; font-size:clamp(12px,2.6vw,14px);}
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
    gap:18px; padding:18px; max-width:1600px; margin:0 auto 20px;
  }
  .card{
    background:linear-gradient(180deg,#0f172a 0%, #0b1220 100%);
    border:1px solid #1f2937; border-radius:16px; padding:18px 18px 22px;
    position:relative; overflow:hidden;
  }
  .title{
    display:flex; align-items:center; justify-content:space-between;
    font-weight:900; margin-bottom:8px; color:#cbd5e1;
  }
  .title .tag{font-size:clamp(16px,3vw,22px)}
  .title .time{font-size:clamp(11px,2vw,13px); color:var(--muted)}
  .big{
    text-align:center;
    font-size:clamp(64px,10vw,120px);
    line-height:1; font-weight:900; letter-spacing:.02em;
    color:#ffffff;
  }
  .pill{
    position:absolute; inset:auto 14px 14px auto; background:#0ea5e9;
    color:#001019; font-weight:900; padding:6px 10px; border-radius:999px;
    font-size:12px; opacity:.9;
  }
  .flash{ animation:flash 900ms ease-out 1; }
  @keyframes flash{
    0%{ box-shadow:0 0 0 0 rgba(34,197,94,.7); transform:scale(1.0); }
    50%{ box-shadow:0 0 40px 4px rgba(34,197,94,.55); transform:scale(1.01); }
    100%{ box-shadow:0 0 0 0 rgba(34,197,94,0); transform:scale(1.0); }
  }
  .num{font-variant-numeric: tabular-nums}
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<!-- ✅ الخطوة 3: تفعيل الصوت يدويًا مرة واحدة -->
<div id="soundGate" style="position:fixed;inset:0;background:#000a;color:#fff;display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column">
  <div style="margin-bottom:10px;font-weight:700">اضغطي لتفعيل الصوت</div>
  <button onclick="document.getElementById('soundGate').style.display='none'; try{speechSynthesis.cancel()}catch(e){}" style="padding:10px 16px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:800;cursor:pointer">تفعيل الصوت</button>
</div>

<header>
  <h1>لوحة النداء</h1>
  <div class="hint">تظهر تحت كل شباك آخر تذكرة مناداة • اضغطي F11 لملء الشاشة</div>
</header>

<div id="grid" class="grid"></div>

<script>
/* ===== إعداد Firebase / نفس بيئتكم ===== */
const ROOT = "cardiac_demo";
const cfg = {
  apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
  authDomain:"q-matic-b7d77.firebaseapp.com",
  databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
  projectId:"q-matic-b7d77",
  storageBucket:"q-matic-b7d77.appspot.com",
  messagingSenderId:"908187704899",
  appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
};
firebase.initializeApp(cfg);
const db = firebase.database();

/* ===== إعدادات العرض ===== */
const MAX_WINDOWS = 3; // عدّليها حسب عدد الشبابيك

/* ===== أدوات ===== */
function toArDigits(n){ return String(n).replace(/\d/g,d=>"٠١٢٣٤٥٦٧٨٩"[d]); }
function timeHHMM(ts){
  const d = new Date(ts||Date.now());
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}

/* ===== بناء الكروت ===== */
const grid = document.getElementById('grid');
const cards = {};
for(let w=1; w<=MAX_WINDOWS; w++){
  const c = document.createElement('div');
  c.className = 'card';
  c.innerHTML = `
    <div class="title">
      <div class="tag">شباك <span class="num">${toArDigits(w)}</span></div>
      <div class="time" id="t${w}">—</div>
    </div>
    <div class="big num" id="n${w}">—</div>
    <div class="pill">آخر نداء</div>
  `;
  grid.appendChild(c);
  cards[w] = { root: c, n: c.querySelector("#n"+w), t: c.querySelector("#t"+w) };
}

/* ===== تحديث الكرت ===== */
function updateWindowCard(w, ticket, ts){
  const card = cards[w];
  if(!card) return;
  card.n.textContent = ticket? toArDigits(ticket) : "—";
  card.t.textContent = ts ? toArDigits(timeHHMM(ts)) : "—";
  card.root.classList.remove('flash'); void card.root.offsetWidth; card.root.classList.add('flash');
}

/* =========================
   ✅ الخطوة 1: نسخ دوال النطق
   ========================= */

/* 1.1 دالة speakOnce */
function speakOnce(text) {
  return new Promise(resolve => {
    if (!('speechSynthesis' in window)) { resolve(); return; }

    // حذف التنوين والسكون
    text = text.replace(/[ٌٍْـ]/g, "").replace(/\s+/g, " ").trim();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ar-SA';
    u.rate = 1.1;
    u.pitch = 1.0;

    const voices = window.speechSynthesis.getVoices();
    const v = voices.find(v => /naayf|naif|hoda|maged|arabic/i.test(v.name)) ||
              voices.find(v => /ar(-|_)?[A-Z]{2}/i.test(v.lang)) ||
              voices[0];
    if (v) u.voice = v;

    u.onend = resolve;
    u.onerror = resolve;
    window.speechSynthesis.speak(u);
  });
}

/* 1.2 دالة fixNumberWord */
function fixNumberWord(n) {
  const map = {
    1: "واحِد",
    2: "اِثنان",
    3: "ثَلاثَة",
    4: "أَربَعَة",
    5: "خَمسَة",
    6: "سِتَّة",
    7: "سَبعَة",
    8: "ثَمانِيَة",
    9: "تِسعَة",
    10: "عَشَرَة"
  };
  return map[n] ? map[n] : toArDigits(n);
}

/* 1.3 دالة buildFastPhrase */
function buildFastPhrase(n, w) {
  const z = "\u200C";
  const num = toArDigits(n);
  const wnum = (w == null || w === "") ? "" : fixNumberWord(w);

  if (!wnum)
    return `تَذْكِرَةْ رقم${z} ${num}`;
  return `تَذْكِرَةْ رقم${z} ${num} الرجاء${z} التوجه${z} إلى${z} الشُبّاك رقم${z} ${wnum}`;
}

/* =========================
   ✅ الخطوة 2: تشغيل النطق عند كل نداء
   ========================= */
const bootTs = Date.now() - 10000;
db.ref(`${ROOT}/calls`)
  .orderByChild('ts')
  .startAt(bootTs)
  .on('child_added', snap=>{
    const v = snap.val()||{};
    const n = Number(v.number);
    const w = (v.window===0||v.window)? Number(v.window) : null;

    if(!n || !w || w<1 || w>MAX_WINDOWS) return;

    // تحديث الكرت
    updateWindowCard(w, n, v.ts || Date.now());

    // نطق الجملة
    const phrase = buildFastPhrase(n, w);
    speakOnce(phrase);
  });

/* لتحديث قائمة الأصوات عند جاهزيتها (اختياري) */
window.speechSynthesis.onvoiceschanged = ()=>{ /* لا شيء مطلوب، مجرد إيقاظ */ };
</script>
</body>
</html>
