<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>لوحة النداء</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f172a; --ink:#ffffff;
    --accent:#38bdf8; --divider:#334155;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:-apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    display:flex; flex-direction:column; min-height:100vh;
  }
  .header{padding:min(2.2vh,24px) min(2vw,24px); text-align:center; background:#111827; border-bottom:2px solid var(--divider);}
  .header h1{margin:0; font-weight:900; letter-spacing:.5px; font-size:clamp(20px,4.8vw,64px);}

  .rows{flex:1; display:flex; flex-direction:column;}
  .row{flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
       padding:min(2vh,28px) min(2vw,28px); position:relative;}
  .row + .row{border-top:2.5px solid var(--divider);}

  .label{font-weight:900; opacity:.95; line-height:1.1; margin-bottom:.4em; font-size:clamp(22px,4.2vw,56px);}
  .ticket{font-weight:900; color:var(--accent); line-height:1; letter-spacing:.5px; font-size:clamp(42px,16vw,180px);}

  .flash{animation:flash 900ms ease-out;}
  @keyframes flash{0%{transform:scale(.98); filter:brightness(1.6);} 100%{transform:scale(1); filter:brightness(1);}}
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<!-- زر تفعيل الصوت مرّة واحدة -->
<div id="soundGate" style="position:fixed;inset:0;background:#000a;color:#fff;display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column">
  <div style="font-size:clamp(16px,3.6vw,28px);margin-bottom:12px">اضغط “تفعيل الصوت” للسماح بالنطق</div>
  <button id="enableBtn" style="padding:12px 18px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:800;cursor:pointer;font-size:clamp(14px,3.2vw,20px)">تفعيل الصوت</button>
</div>

<div class="header"><h1>النداء الحالي</h1></div>

<div class="rows">
  <div class="row" id="w1">
    <div class="label">شباك 1</div>
    <div class="ticket" id="t1">—</div>
  </div>
  <div class="row" id="w2">
    <div class="label">شباك 2</div>
    <div class="ticket" id="t2">—</div>
  </div>
  <div class="row" id="w3">
    <div class="label">شباك 3</div>
    <div class="ticket" id="t3">—</div>
  </div>
</div>

<script>
/* ===== Firebase ===== */
const cfg={
  apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
  authDomain:"q-matic-b7d77.firebaseapp.com",
  databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
  projectId:"q-matic-b7d77",
  storageBucket:"q-matic-b7d77.appspot.com",
  messagingSenderId:"908187704899",
  appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
};
firebase.initializeApp(cfg);
const db   = firebase.database();
const ROOT = "cardiac_demo";

/* ===== أدوات عرض ===== */
function toArDigits(n){ return String(n).replace(/\d/g,d=>"٠١٢٣٤٥٦٧٨٩"[d]); }
function flash(el){ el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash'); }

/* ===== الصوت (نفس إعدادات announcer) ===== */
let ttsReady=false;
document.getElementById('enableBtn').onclick=()=>{
  try{ speechSynthesis.cancel(); }catch(e){}
  ttsReady=true;
  document.getElementById('soundGate').style.display='none';
};
function speakOnce(text){
  return new Promise(resolve=>{
    if(!ttsReady || !('speechSynthesis' in window)){ resolve(); return; }
    text = text.replace(/[ٌٍْـ]/g,"").replace(/\s+/g," ").trim(); // إزالة التنوين والسكون
    const u = new SpeechSynthesisUtterance(text);
    u.lang='ar-SA'; u.rate=1.1; u.pitch=1.0;
    const voices=speechSynthesis.getVoices()||[];
    const v = voices.find(v=>/naayf|naif|hoda|maged|arabic/i.test(v.name))
         || voices.find(v=>/ar(-|_)?[A-Z]{2}/i.test(v.lang))
         || voices[0];
    if(v) u.voice=v;
    u.onend=resolve; u.onerror=resolve;
    speechSynthesis.speak(u);
  });
}
function fixNumberWord(n){
  const map={1:"واحِد",2:"اِثنان",3:"ثَلاثَة",4:"أَربَعَة",5:"خَمسَة",6:"سِتَّة",7:"سَبعَة",8:"ثَمانِيَة",9:"تِسعَة",10:"عَشَرَة"};
  return map[n]?map[n]:toArDigits(n);
}
function buildFastPhrase(n,w){
  const z="\u200C";
  const num = toArDigits(n);
  const wnum = (w==null||w==="")? "": fixNumberWord(Number(w));
  if(!wnum) return `تَذْكِرَةْ رقم${z} ${num}`;
  return `تَذْكِرَةْ رقم${z} ${num} الرجاء${z} التوجه${z} إلى${z} الشباك رقم${z} ${wnum}`;
}

/* ===== تحديث الشاشة + نطق الجملة ===== */
const bootTs = Date.now()-10_000;
db.ref(`${ROOT}/calls`)
  .orderByChild('ts')
  .startAt(bootTs)
  .on('child_added', snap=>{
    const v = snap.val()||{};
    const n = Number(v.number);
    let   w = v.window ?? v.win ?? v.windowNum ?? v.counter ?? null;

    if (typeof w==='string'){ const p=Number(w); w = Number.isNaN(p)? w.trim(): p; }
    if (![1,2,3].includes(Number(w))) return;
    if (!n) return;

    const ticketEl=document.getElementById(`t${w}`);
    if(!ticketEl) return;

    ticketEl.textContent = toArDigits(n);
    flash(ticketEl);

    // النطق بنفس أسلوب announcer
    const phrase = buildFastPhrase(n, w);
    speakOnce(phrase);
  });
</script>
</body>
</html>
